name: Set Commit Statuses
description: |
  Consumes the artifacts generated by the test-commit action to set the status
  of each commit in the parent repository.  This should be trigged as a
  workflow_run after the workflow that called test-commit.  By separating the
  testing from setting of statuses, we limit a malicious repository to only
  being able to mess with statuses.

runs:
  using: "composite"
  steps:
    - name: Fetch Commit Statuses
      id: fetch-statuses
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "Fetch Commit Statuses"
        gh run -R ${{ github.repository }} download -p "test-commit*.status" ${{ github.event.workflow_run.id }}
    - name: Set Commit Statuses
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        set -e
        rc=0

        echo "Parsing statuses"
        for json in test-commit-*.status/test-commit-*.status; do
          state=$(jq -r '.state' ${json})
          sha=$(jq -r '.sha' ${json})
          context=$(jq -r '.context' ${json})
          target_url=$(jq -r '.target_url' ${json})

          echo "::group::Setting state=${state} for ${sha}"
          if ! gh api -X POST repos/${{ github.repository }}/statuses/${sha} \
              -f state="${state}" \
              -f context="${context}" \
              -f description="Test ${state}" \
              -f target_url="${target_url}"; then
            rc=1
          fi
          echo "::endgroup::"
        done
        exit ${rc}
